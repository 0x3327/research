<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
  <meta charset="utf-8">
  <meta name="generator" content="quarto-0.9.64">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>3327 Research – threadsafe_function</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>

  <script src="../../../../../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
  <script src="../../../../../../../../../site_libs/quarto-nav/headroom.min.js"></script>
  <script src="../../../../../../../../../site_libs/clipboard/clipboard.min.js"></script>
  <meta name="quarto:offset" content="../../../../../../../../../">
  <script src="../../../../../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
  <script src="../../../../../../../../../site_libs/quarto-search/fuse.min.js"></script>
  <script src="../../../../../../../../../site_libs/quarto-search/quarto-search.js"></script>
  <link href="../../../../../../../../..//images/favicon.ico" rel="icon">
  <script src="../../../../../../../../../site_libs/quarto-html/quarto.js"></script>
  <script src="../../../../../../../../../site_libs/quarto-html/popper.min.js"></script>
  <script src="../../../../../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
  <script src="../../../../../../../../../site_libs/quarto-html/anchor.min.js"></script>
  <link href="../../../../../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
  <link href="../../../../../../../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
  <script src="../../../../../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
  <link href="../../../../../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
  <link href="../../../../../../../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
  <script id="quarto-search-options" type="application/json">{
    "location": "navbar",
    "copy-button": false,
    "collapse-after": 2,
    "panel-placement": "end",
    "type": "overlay",
    "limit": 20,
    "language": {
      "search-no-results-text": "No results",
      "search-matching-documents-text": "matching documents",
      "search-copy-link-title": "Copy link to search",
      "search-hide-matches-text": "Hide additional matches",
      "search-more-match-text": "more match in this document",
      "search-more-matches-text": "more matches in this document",
      "search-clear-button-title": "Clear",
      "search-detached-cancel-button-title": "Cancel",
      "search-submit-button-title": "Submit"
    }
  }</script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="../../../../../../../../../styles.css">
</head>
<body>
<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../../../../../../../../index.html">
    <img src="../../../../../../../../../logo.png" alt="">
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../../../../../../index.html">Overview</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../../../../../documents/research/index.html">Research</a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/3327_io"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/0x3327/research"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
<h2 id="toc-title">On this page</h2>
<ul>
<li><a href="#threadsafefunction" class="nav-link active" data-scroll-target="#threadsafefunction">ThreadSafeFunction</a>
<ul class="collapse">
<li><a href="#methods" class="nav-link" data-scroll-target="#methods">Methods</a>
<ul class="collapse">
<li><a href="#constructor" class="nav-link" data-scroll-target="#constructor">Constructor</a></li>
<li><a href="#constructor-1" class="nav-link" data-scroll-target="#constructor-1">Constructor</a></li>
<li><a href="#new" class="nav-link" data-scroll-target="#new">New</a></li>
<li><a href="#acquire" class="nav-link" data-scroll-target="#acquire">Acquire</a></li>
<li><a href="#release" class="nav-link" data-scroll-target="#release">Release</a></li>
<li><a href="#abort" class="nav-link" data-scroll-target="#abort">Abort</a></li>
<li><a href="#blockingcall-nonblockingcall" class="nav-link" data-scroll-target="#blockingcall-nonblockingcall">BlockingCall / NonBlockingCall</a></li>
</ul></li>
<li><a href="#example" class="nav-link" data-scroll-target="#example">Example</a></li>
</ul></li>
</ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/0x3327/research/edit/main/documents/research/assets/ERFC-42/research_examples/hardhat-test-example/node_modules/node-addon-api/doc/threadsafe_function.md" class="toc-action">Edit this page</a></p><p><a href="https://github.com/0x3327/research/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<section id="threadsafefunction" class="level1">
<h1>ThreadSafeFunction</h1>
<p>JavaScript functions can normally only be called from a native addon’s main thread. If an addon creates additional threads, then node-addon-api functions that require a <code>Napi::Env</code>, <code>Napi::Value</code>, or <code>Napi::Reference</code> must not be called from those threads.</p>
<p>When an addon has additional threads and JavaScript functions need to be invoked based on the processing completed by those threads, those threads must communicate with the addon’s main thread so that the main thread can invoke the JavaScript function on their behalf. The thread-safe function APIs provide an easy way to do this.</p>
<p>These APIs provide the type <code>Napi::ThreadSafeFunction</code> as well as APIs to create, destroy, and call objects of this type. <code>Napi::ThreadSafeFunction::New()</code> creates a persistent reference that holds a JavaScript function which can be called from multiple threads. The calls happen asynchronously. This means that values with which the JavaScript callback is to be called will be placed in a queue, and, for each value in the queue, a call will eventually be made to the JavaScript function.</p>
<p><code>Napi::ThreadSafeFunction</code> objects are destroyed when every thread which uses the object has called <code>Release()</code> or has received a return status of <code>napi_closing</code> in response to a call to <code>BlockingCall()</code> or <code>NonBlockingCall()</code>. The queue is emptied before the <code>Napi::ThreadSafeFunction</code> is destroyed. It is important that <code>Release()</code> be the last API call made in conjunction with a given <code>Napi::ThreadSafeFunction</code>, because after the call completes, there is no guarantee that the <code>Napi::ThreadSafeFunction</code> is still allocated. For the same reason it is also important that no more use be made of a thread-safe function after receiving a return value of <code>napi_closing</code> in response to a call to <code>BlockingCall()</code> or <code>NonBlockingCall()</code>. Data associated with the <code>Napi::ThreadSafeFunction</code> can be freed in its <code>Finalizer</code> callback which was passed to <code>ThreadSafeFunction::New()</code>.</p>
<p>Once the number of threads making use of a <code>Napi::ThreadSafeFunction</code> reaches zero, no further threads can start making use of it by calling <code>Acquire()</code>. In fact, all subsequent API calls associated with it, except <code>Release()</code>, will return an error value of <code>napi_closing</code>.</p>
<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">Methods</h2>
<section id="constructor" class="level3">
<h3 class="anchored" data-anchor-id="constructor">Constructor</h3>
<p>Creates a new empty instance of <code>Napi::ThreadSafeFunction</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>Napi<span class="op">::</span>Function<span class="op">::</span>ThreadSafeFunction<span class="op">();</span></span></code></pre></div>
</section>
<section id="constructor-1" class="level3">
<h3 class="anchored" data-anchor-id="constructor-1">Constructor</h3>
<p>Creates a new instance of the <code>Napi::ThreadSafeFunction</code> object.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>Napi<span class="op">::</span>ThreadSafeFunction<span class="op">::</span>ThreadSafeFunction<span class="op">(</span>napi_threadsafe_function tsfn<span class="op">);</span></span></code></pre></div>
<ul>
<li><code>tsfn</code>: The <code>napi_threadsafe_function</code> which is a handle for an existing thread-safe function.</li>
</ul>
<p>Returns a non-empty <code>Napi::ThreadSafeFunction</code> instance. When using this constructor, only use the <code>Blocking(void*)</code> / <code>NonBlocking(void*)</code> overloads; the <code>Callback</code> and templated <code>data*</code> overloads should <em>not</em> be used. See below for additional details.</p>
</section>
<section id="new" class="level3">
<h3 class="anchored" data-anchor-id="new">New</h3>
<p>Creates a new instance of the <code>Napi::ThreadSafeFunction</code> object. The <code>New</code> function has several overloads for the various optional parameters: skip the optional parameter for that specific overload.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>New<span class="op">(</span>napi_env env<span class="op">,</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> Function<span class="op">&amp;</span> callback<span class="op">,</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> Object<span class="op">&amp;</span> resource<span class="op">,</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    ResourceString resourceName<span class="op">,</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> maxQueueSize<span class="op">,</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> initialThreadCount<span class="op">,</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    ContextType<span class="op">*</span> context<span class="op">,</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    Finalizer finalizeCallback<span class="op">,</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    FinalizerDataType<span class="op">*</span> data<span class="op">);</span></span></code></pre></div>
<ul>
<li><code>env</code>: The <code>napi_env</code> environment in which to construct the <code>Napi::ThreadSafeFunction</code> object.</li>
<li><code>callback</code>: The <code>Function</code> to call from another thread.</li>
<li><code>[optional] resource</code>: An object associated with the async work that will be passed to possible async_hooks init hooks.</li>
<li><code>resourceName</code>: A JavaScript string to provide an identifier for the kind of resource that is being provided for diagnostic information exposed by the async_hooks API.</li>
<li><code>maxQueueSize</code>: Maximum size of the queue. <code>0</code> for no limit.</li>
<li><code>initialThreadCount</code>: The initial number of threads, including the main thread, which will be making use of this function.</li>
<li><code>[optional] context</code>: Data to attach to the resulting <code>ThreadSafeFunction</code>.</li>
<li><code>[optional] finalizeCallback</code>: Function to call when the <code>ThreadSafeFunction</code> is being destroyed. This callback will be invoked on the main thread when the thread-safe function is about to be destroyed. It receives the context and the finalize data given during construction (if given), and provides an opportunity for cleaning up after the threads e.g.&nbsp;by calling <code>uv_thread_join()</code>. It is important that, aside from the main loop thread, there be no threads left using the thread-safe function after the finalize callback completes. Must implement <code>void operator()(Env env, DataType* data,   Context* hint)</code>, skipping <code>data</code> or <code>hint</code> if they are not provided. Can be retreived via <code>GetContext()</code>.</li>
<li><code>[optional] data</code>: Data to be passed to <code>finalizeCallback</code>.</li>
</ul>
<p>Returns a non-empty <code>Napi::ThreadSafeFunction</code> instance.</p>
</section>
<section id="acquire" class="level3">
<h3 class="anchored" data-anchor-id="acquire">Acquire</h3>
<p>Add a thread to this thread-safe function object, indicating that a new thread will start making use of the thread-safe function.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>napi_status Napi<span class="op">::</span>ThreadSafeFunction<span class="op">::</span>Acquire<span class="op">()</span></span></code></pre></div>
<p>Returns one of: - <code>napi_ok</code>: The thread has successfully acquired the thread-safe function for its use. - <code>napi_closing</code>: The thread-safe function has been marked as closing via a previous call to <code>Abort()</code>.</p>
</section>
<section id="release" class="level3">
<h3 class="anchored" data-anchor-id="release">Release</h3>
<p>Indicate that an existing thread will stop making use of the thread-safe function. A thread should call this API when it stops making use of this thread-safe function. Using any thread-safe APIs after having called this API has undefined results in the current thread, as it may have been destroyed.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>napi_status Napi<span class="op">::</span>ThreadSafeFunction<span class="op">::</span>Release<span class="op">()</span></span></code></pre></div>
<p>Returns one of: - <code>napi_ok</code>: The thread-safe function has been successfully released. - <code>napi_invalid_arg</code>: The thread-safe function’s thread-count is zero. - <code>napi_generic_failure</code>: A generic error occurred when attemping to release the thread-safe function.</p>
</section>
<section id="abort" class="level3">
<h3 class="anchored" data-anchor-id="abort">Abort</h3>
<p>“Abort” the thread-safe function. This will cause all subsequent APIs associated with the thread-safe function except <code>Release()</code> to return <code>napi_closing</code> even before its reference count reaches zero. In particular, <code>BlockingCall</code> and <code>NonBlockingCall()</code> will return <code>napi_closing</code>, thus informing the threads that it is no longer possible to make asynchronous calls to the thread-safe function. This can be used as a criterion for terminating the thread. Upon receiving a return value of <code>napi_closing</code> from a thread-safe function call a thread must make no further use of the thread-safe function because it is no longer guaranteed to be allocated.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>napi_status Napi<span class="op">::</span>ThreadSafeFunction<span class="op">::</span>Abort<span class="op">()</span></span></code></pre></div>
<p>Returns one of: - <code>napi_ok</code>: The thread-safe function has been successfully aborted. - <code>napi_invalid_arg</code>: The thread-safe function’s thread-count is zero. - <code>napi_generic_failure</code>: A generic error occurred when attemping to abort the thread-safe function.</p>
</section>
<section id="blockingcall-nonblockingcall" class="level3">
<h3 class="anchored" data-anchor-id="blockingcall-nonblockingcall">BlockingCall / NonBlockingCall</h3>
<p>Calls the Javascript function in either a blocking or non-blocking fashion. - <code>BlockingCall()</code>: the API blocks until space becomes available in the queue. Will never block if the thread-safe function was created with a maximum queue size of <code>0</code>. - <code>NonBlockingCall()</code>: will return <code>napi_queue_full</code> if the queue was full, preventing data from being successfully added to the queue.</p>
<p>There are several overloaded implementations of <code>BlockingCall()</code> and <code>NonBlockingCall()</code> for use with optional parameters: skip the optional parameter for that specific overload.</p>
<p><strong>These specific function overloads should only be used on a <code>ThreadSafeFunction</code> created via <code>ThreadSafeFunction::New</code>.</strong></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>napi_status Napi<span class="op">::</span>ThreadSafeFunction<span class="op">::</span>BlockingCall<span class="op">(</span>DataType<span class="op">*</span> data<span class="op">,</span> Callback callback<span class="op">)</span> <span class="at">const</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>napi_status Napi<span class="op">::</span>ThreadSafeFunction<span class="op">::</span>NonBlockingCall<span class="op">(</span>DataType<span class="op">*</span> data<span class="op">,</span> Callback callback<span class="op">)</span> <span class="at">const</span></span></code></pre></div>
<ul>
<li><code>[optional] data</code>: Data to pass to <code>callback</code>.</li>
<li><code>[optional] callback</code>: C++ function that is invoked on the main thread. The callback receives the <code>ThreadSafeFunction</code>’s JavaScript callback function to call as an <code>Napi::Function</code> in its parameters and the <code>DataType*</code> data pointer (if provided). Must implement <code>void operator()(Napi::Env env, Function   jsCallback, DataType* data)</code>, skipping <code>data</code> if not provided. It is not necessary to call into JavaScript via <code>MakeCallback()</code> because N-API runs <code>callback</code> in a context appropriate for callbacks.</li>
</ul>
<p><strong>These specific function overloads should only be used on a <code>ThreadSafeFunction</code> created via <code>ThreadSafeFunction(napi_threadsafe_function)</code>.</strong></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>napi_status Napi<span class="op">::</span>ThreadSafeFunction<span class="op">::</span>BlockingCall<span class="op">(</span><span class="dt">void</span><span class="op">*</span> data<span class="op">)</span> <span class="at">const</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>napi_status Napi<span class="op">::</span>ThreadSafeFunction<span class="op">::</span>NonBlockingCall<span class="op">(</span><span class="dt">void</span><span class="op">*</span> data<span class="op">)</span> <span class="at">const</span></span></code></pre></div>
<ul>
<li><code>data</code>: Data to pass to <code>call_js_cb</code> specified when creating the thread-safe function via <code>napi_create_threadsafe_function</code>.</li>
</ul>
<p>Returns one of: - <code>napi_ok</code>: The call was successfully added to the queue. - <code>napi_queue_full</code>: The queue was full when trying to call in a non-blocking method. - <code>napi_closing</code>: The thread-safe function is aborted and cannot accept more calls. - <code>napi_invalid_arg</code>: The thread-safe function is closed. - <code>napi_generic_failure</code>: A generic error occurred when attemping to add to the queue.</p>
</section>
</section>
<section id="example" class="level2">
<h2 class="anchored" data-anchor-id="example">Example</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;chrono&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;thread&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;napi.h&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Napi<span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>thread<span class="op"> </span>nativeThread<span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>ThreadSafeFunction tsfn<span class="op">;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>Value Start<span class="op">(</span> <span class="at">const</span> CallbackInfo<span class="op">&amp;</span> info <span class="op">)</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  Napi<span class="op">::</span>Env env <span class="op">=</span> info<span class="op">.</span>Env<span class="op">();</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span> info<span class="op">.</span>Length<span class="op">()</span> <span class="op">&lt;</span> <span class="dv">2</span> <span class="op">)</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> TypeError<span class="op">::</span>New<span class="op">(</span> env<span class="op">,</span> <span class="st">"Expected two arguments"</span> <span class="op">);</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span> <span class="op">!</span>info<span class="op">[</span><span class="dv">0</span><span class="op">].</span>IsFunction<span class="op">()</span> <span class="op">)</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> TypeError<span class="op">::</span>New<span class="op">(</span> env<span class="op">,</span> <span class="st">"Expected first arg to be function"</span> <span class="op">);</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span> <span class="op">!</span>info<span class="op">[</span><span class="dv">1</span><span class="op">].</span>IsNumber<span class="op">()</span> <span class="op">)</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> TypeError<span class="op">::</span>New<span class="op">(</span> env<span class="op">,</span> <span class="st">"Expected second arg to be number"</span> <span class="op">);</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> count <span class="op">=</span> info<span class="op">[</span><span class="dv">1</span><span class="op">].</span>As<span class="op">&lt;</span>Number<span class="op">&gt;().</span>Int32Value<span class="op">();</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create a ThreadSafeFunction</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  tsfn <span class="op">=</span> ThreadSafeFunction<span class="op">::</span>New<span class="op">(</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>      env<span class="op">,</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>      info<span class="op">[</span><span class="dv">0</span><span class="op">].</span>As<span class="op">&lt;</span>Function<span class="op">&gt;(),</span>  <span class="co">// JavaScript function called asynchronously</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Resource Name"</span><span class="op">,</span>         <span class="co">// Name</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>      <span class="dv">0</span><span class="op">,</span>                       <span class="co">// Unlimited queue</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span><span class="op">,</span>                       <span class="co">// Only one thread will use this initially</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>      <span class="op">[](</span> Napi<span class="op">::</span>Env <span class="op">)</span> <span class="op">{</span>        <span class="co">// Finalizer used to clean threads up</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>        nativeThread<span class="op">.</span>join<span class="op">();</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="op">);</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create a native thread</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>  nativeThread <span class="op">=</span> <span class="bu">std::</span>thread<span class="op">(</span> <span class="op">[</span>count<span class="op">]</span> <span class="op">{</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> callback <span class="op">=</span> <span class="op">[](</span> Napi<span class="op">::</span>Env env<span class="op">,</span> Function jsCallback<span class="op">,</span> <span class="dt">int</span><span class="op">*</span> value <span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Transform native data into JS data, passing it to the provided </span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>      <span class="co">// `jsCallback` -- the TSFN's JavaScript function.</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>      jsCallback<span class="op">.</span>Call<span class="op">(</span> <span class="op">{</span>Number<span class="op">::</span>New<span class="op">(</span> env<span class="op">,</span> <span class="op">*</span>value <span class="op">)}</span> <span class="op">);</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>      <span class="co">// We're finished with the data.</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>      <span class="kw">delete</span> value<span class="op">;</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> count<span class="op">;</span> i<span class="op">++</span> <span class="op">)</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Create new data</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span><span class="op">*</span> value <span class="op">=</span> <span class="kw">new</span> <span class="dt">int</span><span class="op">(</span> clock<span class="op">()</span> <span class="op">);</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Perform a blocking call</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>      napi_status status <span class="op">=</span> tsfn<span class="op">.</span>BlockingCall<span class="op">(</span> value<span class="op">,</span> callback <span class="op">);</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span> status <span class="op">!=</span> napi_ok <span class="op">)</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Handle error</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>      <span class="bu">std::</span>this_thread<span class="bu">::</span>sleep_for<span class="op">(</span> <span class="bu">std::</span>chrono<span class="bu">::</span>seconds<span class="op">(</span> <span class="dv">1</span> <span class="op">)</span> <span class="op">);</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Release the thread-safe function</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>    tsfn<span class="op">.</span>Release<span class="op">();</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="op">);</span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Boolean<span class="op">::</span>New<span class="op">(</span>env<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>Napi<span class="op">::</span>Object Init<span class="op">(</span> Napi<span class="op">::</span>Env env<span class="op">,</span> Object exports <span class="op">)</span></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>  exports<span class="op">.</span>Set<span class="op">(</span> <span class="st">"start"</span><span class="op">,</span> Function<span class="op">::</span>New<span class="op">(</span> env<span class="op">,</span> Start <span class="op">)</span> <span class="op">);</span></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> exports<span class="op">;</span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>NODE_API_MODULE<span class="op">(</span> clock<span class="op">,</span> Init <span class="op">)</span></span></code></pre></div>
<p>The above code can be used from JavaScript as follows:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { start } <span class="op">=</span> <span class="pp">require</span>(<span class="st">'bindings'</span>)(<span class="st">'clock'</span>)<span class="op">;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">start</span>(<span class="kw">function</span> () {</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">"JavaScript callback called with arguments"</span><span class="op">,</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">arguments</span>))<span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> <span class="dv">5</span>)<span class="op">;</span></span></code></pre></div>
<p>When executed, the output will show the value of <code>clock()</code> five times at one second intervals:</p>
<pre><code>JavaScript callback called with arguments [ 84745 ]
JavaScript callback called with arguments [ 103211 ]
JavaScript callback called with arguments [ 104516 ]
JavaScript callback called with arguments [ 105104 ]
JavaScript callback called with arguments [ 105691 ]</code></pre>


</section>
</section>
</main> <!-- /main -->
<script type="text/javascript">

// replace cmd keyboard shortcut w/ control on non-Mac platforms
const kPlatformMac = typeof navigator !== 'undefined' ? /Mac/.test(navigator.platform) : false;
if (!kPlatformMac) {
   var kbds = document.querySelectorAll("kbd")
   kbds.forEach(function(kbd) {
      kbd.innerHTML = kbd.innerHTML.replace(/⌘/g, '⌃');
   });
}

</script>
<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Proudly supported by <a href="https://mvpworkshop.co"><img src="https://mvpworkshop.co/wp-content/uploads/2021/01/mvp-logo.png" class="img-fluid" width="65"></a></div>   
      <div class="nav-footer-center">
        <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="../../../../../../../../../about.html">About</a>
  </li>  
</ul>
      </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/3327_io">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/0x3327/research">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>


</body></html>